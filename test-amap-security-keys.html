<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•é«˜å¾·åœ°å›¾å®‰å…¨å¯†é’¥é…ç½®</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .key-list {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .key-item {
            margin: 5px 0;
            font-family: monospace;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª æµ‹è¯•é«˜å¾·åœ°å›¾å®‰å…¨å¯†é’¥é…ç½®</h1>
        
        <div id="status"></div>
        
        <div class="key-list" id="keysInfo" style="display: none;">
            <h3>ğŸ”‘ å½“å‰é…ç½®çš„å¯†é’¥</h3>
            <div id="keysList"></div>
        </div>
        
        <div>
            <button onclick="testConfiguration()">æµ‹è¯•é…ç½®</button>
            <button onclick="clearConfiguration()" style="background-color: #dc3545;">æ¸…é™¤é…ç½®</button>
            <button onclick="openSettings()" style="background-color: #28a745;">æ‰“å¼€è®¾ç½®é¡µé¢</button>
        </div>
    </div>

    <script type="module">
        import { autoConfigureApiKeys, checkApiKeysStatus } from './src/services/preconfiguredApiKeys.js';
        import { mapService } from './src/services/mapService.js';

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function updateKeysList(keys) {
            const keysInfo = document.getElementById('keysInfo');
            const keysList = document.getElementById('keysList');
            
            if (keys && Object.keys(keys).length > 0) {
                keysInfo.style.display = 'block';
                keysList.innerHTML = '';
                
                Object.entries(keys).forEach(([key, value]) => {
                    const maskedValue = value ? `${value.substring(0, 8)}...${value.substring(value.length - 4)}` : 'æœªé…ç½®';
                    const keyItem = document.createElement('div');
                    keyItem.className = 'key-item';
                    keyItem.innerHTML = `<strong>${key}:</strong> ${maskedValue}`;
                    keysList.appendChild(keyItem);
                });
            } else {
                keysInfo.style.display = 'none';
            }
        }

        async function testConfiguration() {
            updateStatus('ğŸ”§ æ­£åœ¨æµ‹è¯•é…ç½®...', 'info');

            try {
                // è‡ªåŠ¨é…ç½®APIå¯†é’¥
                const configured = autoConfigureApiKeys();
                
                if (configured) {
                    updateStatus('âœ… APIå¯†é’¥è‡ªåŠ¨é…ç½®æˆåŠŸ', 'success');
                } else {
                    updateStatus('â„¹ï¸ APIå¯†é’¥å·²å­˜åœ¨ï¼Œæ— éœ€é‡æ–°é…ç½®', 'info');
                }

                // æ£€æŸ¥APIå¯†é’¥çŠ¶æ€
                const status = checkApiKeysStatus();
                
                let statusMessage = `
                    <h3>ğŸ“Š APIå¯†é’¥é…ç½®çŠ¶æ€</h3>
                    <p><strong>å·²é…ç½®:</strong> ${status.configured ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>
                    <p><strong>æ¶ˆæ¯:</strong> ${status.message}</p>
                    <p><strong>ç¼ºå¤±å¯†é’¥:</strong> ${status.missingKeys.join(', ') || 'æ— '}</p>
                `;
                
                updateStatus(statusMessage, status.configured ? 'success' : 'warning');
                
                // æ›´æ–°å¯†é’¥åˆ—è¡¨
                updateKeysList(status.keys);

                // æµ‹è¯•åœ°å›¾æœåŠ¡
                updateStatus('ğŸ—ºï¸ æ­£åœ¨æµ‹è¯•åœ°å›¾æœåŠ¡...', 'info');
                
                try {
                    const apiKey = mapService.getApiKey();
                    const securityKeys = mapService.getSecurityKeys();
                    
                    let mapServiceMessage = `
                        <h3>ğŸ—ºï¸ åœ°å›¾æœåŠ¡æµ‹è¯•ç»“æœ</h3>
                        <p><strong>é«˜å¾·åœ°å›¾API Key:</strong> ${apiKey.substring(0, 8)}...${apiKey.substring(apiKey.length - 4)}</p>
                    `;
                    
                    if (securityKeys && securityKeys.length > 0) {
                        mapServiceMessage += `<p><strong>å®‰å…¨å¯†é’¥:</strong> ${securityKeys.length} ä¸ªå·²é…ç½®</p>`;
                        securityKeys.forEach((key, index) => {
                            mapServiceMessage += `<p>   - å®‰å…¨å¯†é’¥ ${index + 1}: ${key.substring(0, 8)}...${key.substring(key.length - 4)}</p>`;
                        });
                    } else {
                        mapServiceMessage += `<p><strong>å®‰å…¨å¯†é’¥:</strong> âš ï¸ æœªé…ç½®</p>`;
                    }
                    
                    updateStatus(statusMessage + mapServiceMessage, 'success');
                    
                } catch (error) {
                    updateStatus(statusMessage + `<p><strong>åœ°å›¾æœåŠ¡æµ‹è¯•å¤±è´¥:</strong> ${error.message}</p>`, 'error');
                }

            } catch (error) {
                updateStatus(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function clearConfiguration() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰APIå¯†é’¥é…ç½®å—ï¼Ÿ')) {
                localStorage.removeItem('webplanner_api_keys');
                updateStatus('ğŸ—‘ï¸ æ‰€æœ‰APIå¯†é’¥é…ç½®å·²æ¸…é™¤', 'info');
                updateKeysList(null);
            }
        }

        function openSettings() {
            window.open('/app#settings', '_blank');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.addEventListener('DOMContentLoaded', () => {
            updateStatus('ğŸ‘† ç‚¹å‡»"æµ‹è¯•é…ç½®"æŒ‰é’®å¼€å§‹æµ‹è¯•', 'info');
        });
    </script>
</body>
</html>
