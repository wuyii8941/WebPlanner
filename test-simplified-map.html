<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€åŒ–åœ°å›¾åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        #map-container {
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
            margin: 10px 0;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ç®€åŒ–åœ°å›¾åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>æµ‹è¯•è¯´æ˜</h3>
            <p>è¿™ä¸ªæµ‹è¯•é¡µé¢éªŒè¯æ–°çš„ç®€åŒ–åœ°å›¾åŠŸèƒ½ï¼š</p>
            <ul>
                <li>è¿›å…¥è¯¦æƒ…é¡µé¢ï¼Œç‚¹å‡»æŸ¥çœ‹åœ°å›¾</li>
                <li>æ¸²æŸ“å‡ºå¯¹åº”çš„åŸå¸‚</li>
                <li>æ˜¾ç¤ºå¯¹åº”ç‚¹çš„åæ ‡</li>
                <li>ä¸è¦é™çº§å¤„ç†ï¼Œæœ‰é—®é¢˜ç›´æ¥æŠ¥é”™</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>åœ°å›¾å®¹å™¨</h3>
            <div id="map-container"></div>
            <button onclick="testMap()">æµ‹è¯•åœ°å›¾åŠŸèƒ½</button>
            <button onclick="clearMap()">æ¸…é™¤åœ°å›¾</button>
        </div>

        <div class="test-section">
            <h3>æµ‹è¯•æ—¥å¿—</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿæ—…è¡Œæ•°æ®
        const testTrip = {
            destination: "åŒ—äº¬å¸‚",
            itinerary: [
                {
                    title: "å¤©å®‰é—¨å¹¿åœº",
                    location: "å¤©å®‰é—¨å¹¿åœº",
                    time: "09:00",
                    duration: 120
                },
                {
                    title: "æ•…å®«åšç‰©é™¢",
                    location: "æ•…å®«åšç‰©é™¢",
                    time: "11:00",
                    duration: 180
                },
                {
                    title: "ç‹åºœäº•å¤§è¡—",
                    location: "ç‹åºœäº•å¤§è¡—",
                    time: "14:00",
                    duration: 90
                }
            ]
        };

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // æµ‹è¯•åœ°å›¾åŠŸèƒ½
        async function testMap() {
            log("ğŸš€ å¼€å§‹æµ‹è¯•åœ°å›¾åŠŸèƒ½...");
            
            try {
                // æ£€æŸ¥æ˜¯å¦é…ç½®äº†API Key
                const apiKeys = localStorage.getItem('webplanner_api_keys');
                if (!apiKeys) {
                    throw new Error('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®ç™¾åº¦åœ°å›¾API Key');
                }
                
                const parsedKeys = JSON.parse(apiKeys);
                if (!parsedKeys.baiduApiKey) {
                    throw new Error('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®ç™¾åº¦åœ°å›¾API Key');
                }
                
                log("âœ… API Key é…ç½®æ­£ç¡®");

                // åŠ è½½ç™¾åº¦åœ°å›¾API
                await loadBaiduMapAPI(parsedKeys.baiduApiKey);
                
                // åˆå§‹åŒ–åœ°å›¾
                const map = await initMap();
                
                // æ˜¾ç¤ºæ—…è¡Œä¿¡æ¯
                await showTripOnMap(map, testTrip);
                
                log("âœ… åœ°å›¾åŠŸèƒ½æµ‹è¯•æˆåŠŸï¼");
                
            } catch (error) {
                log(`âŒ åœ°å›¾åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}`);
                console.error('æµ‹è¯•å¤±è´¥:', error);
            }
        }

        // åŠ è½½ç™¾åº¦åœ°å›¾API
        function loadBaiduMapAPI(apiKey) {
            return new Promise((resolve, reject) => {
                if (typeof BMap !== 'undefined') {
                    log("âœ… ç™¾åº¦åœ°å›¾APIå·²åŠ è½½");
                    resolve();
                    return;
                }

                log("ğŸš€ å¼€å§‹åŠ è½½ç™¾åº¦åœ°å›¾API...");
                
                const script = document.createElement('script');
                script.src = `https://api.map.baidu.com/api?v=3.0&ak=${apiKey}&callback=baiduMapInitCallback`;
                script.async = true;
                
                window.baiduMapInitCallback = () => {
                    log("âœ… ç™¾åº¦åœ°å›¾APIåŠ è½½æˆåŠŸ");
                    resolve();
                };
                
                script.onerror = () => {
                    log("âŒ ç™¾åº¦åœ°å›¾APIåŠ è½½å¤±è´¥");
                    reject(new Error('ç™¾åº¦åœ°å›¾APIåŠ è½½å¤±è´¥'));
                };
                
                document.head.appendChild(script);
                
                setTimeout(() => {
                    if (typeof BMap === 'undefined') {
                        log("âŒ ç™¾åº¦åœ°å›¾APIåŠ è½½è¶…æ—¶");
                        reject(new Error('ç™¾åº¦åœ°å›¾APIåŠ è½½è¶…æ—¶'));
                    }
                }, 10000);
            });
        }

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            return new Promise((resolve, reject) => {
                try {
                    const mapContainer = document.getElementById('map-container');
                    if (!mapContainer) {
                        throw new Error('æœªæ‰¾åˆ°åœ°å›¾å®¹å™¨');
                    }
                    
                    const map = new BMap.Map('map-container');
                    const point = new BMap.Point(116.404, 39.915); // åŒ—äº¬ä¸­å¿ƒ
                    map.centerAndZoom(point, 12);
                    map.enableScrollWheelZoom(true);
                    
                    // æ·»åŠ æ§ä»¶
                    map.addControl(new BMap.NavigationControl());
                    map.addControl(new BMap.ScaleControl());
                    map.addControl(new BMap.OverviewMapControl());
                    
                    log("âœ… åœ°å›¾åˆå§‹åŒ–æˆåŠŸ");
                    resolve(map);
                    
                } catch (error) {
                    log(`âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                    reject(error);
                }
            });
        }

        // æ˜¾ç¤ºæ—…è¡Œä¿¡æ¯
        async function showTripOnMap(map, trip) {
            log("ğŸ—ºï¸ å¼€å§‹æ˜¾ç¤ºæ—…è¡Œä¿¡æ¯...");
            
            // æ¸…é™¤æ—§æ ‡è®°
            map.clearOverlays();
            
            const points = [];
            
            try {
                // æ˜¾ç¤ºç›®çš„åœ°
                if (trip.destination) {
                    log(`ğŸ“ å¤„ç†ç›®çš„åœ°: ${trip.destination}`);
                    const destinationPoint = await geocodeAddress(trip.destination);
                    if (destinationPoint) {
                        points.push(destinationPoint);
                        addMarker(map, destinationPoint, trip.destination, 'ç›®çš„åœ°');
                        log("âœ… ç›®çš„åœ°æ ‡è®°æ·»åŠ æˆåŠŸ");
                    }
                }
                
                // æ˜¾ç¤ºè¡Œç¨‹åœ°ç‚¹
                if (trip.itinerary && trip.itinerary.length > 0) {
                    log(`ğŸ—ºï¸ å¤„ç†è¡Œç¨‹åœ°ç‚¹ï¼Œæ•°é‡: ${trip.itinerary.length}`);
                    
                    for (const [index, item] of trip.itinerary.entries()) {
                        if (item.location) {
                            try {
                                log(`ğŸ“ å¤„ç†è¡Œç¨‹åœ°ç‚¹ ${index + 1}: ${item.title} (${item.location})`);
                                const locationPoint = await geocodeAddress(item.location);
                                if (locationPoint) {
                                    points.push(locationPoint);
                                    addNumberedMarker(map, locationPoint, item, index + 1);
                                    log(`âœ… è¡Œç¨‹åœ°ç‚¹æ ‡è®°æ·»åŠ æˆåŠŸ: ${item.title}`);
                                }
                            } catch (error) {
                                log(`âŒ æ— æ³•è§£æè¡Œç¨‹åœ°ç‚¹: ${item.location}`);
                            }
                        }
                    }
                }
                
                // è°ƒæ•´åœ°å›¾è§†é‡
                if (points.length > 0) {
                    const viewport = map.getViewport(points);
                    let zoomLevel = viewport.zoom;
                    if (points.length === 1) zoomLevel = 14;
                    else if (points.length <= 3) zoomLevel = 12;
                    
                    map.centerAndZoom(viewport.center, zoomLevel);
                    log("âœ… åœ°å›¾è§†é‡è°ƒæ•´å®Œæˆ");
                }
                
            } catch (error) {
                log(`âŒ æ˜¾ç¤ºæ—…è¡Œåœ°å›¾å¤±è´¥: ${error.message}`);
                throw error;
            }
        }

        // åœ°ç†ç¼–ç 
        function geocodeAddress(address) {
            return new Promise((resolve, reject) => {
                const geocoder = new BMap.Geocoder();
                geocoder.getPoint(address, (point) => {
                    if (point) {
                        log(`âœ… åœ°ç†ç¼–ç æˆåŠŸ: ${address} -> (${point.lng}, ${point.lat})`);
                        resolve(point);
                    } else {
                        log(`âŒ åœ°ç†ç¼–ç å¤±è´¥: ${address}`);
                        reject(new Error(`åœ°å€è§£æå¤±è´¥: ${address}`));
                    }
                });
            });
        }

        // æ·»åŠ æ ‡è®°
        function addMarker(map, point, title, type) {
            const marker = new BMap.Marker(point);
            
            const infoWindow = new BMap.InfoWindow(
                `<div style="padding:10px;">
                    <strong>${type}: ${title}</strong>
                </div>`,
                { width: 200, height: 50 }
            );

            marker.addEventListener('click', () => {
                map.openInfoWindow(infoWindow, point);
            });

            map.addOverlay(marker);
            return marker;
        }

        // æ·»åŠ å¸¦ç¼–å·çš„æ ‡è®°
        function addNumberedMarker(map, point, item, index) {
            // åˆ›å»ºè‡ªå®šä¹‰æ ‡ç­¾
            const label = new BMap.Label(`${index}`, {
                offset: new BMap.Size(-6, -20)
            });
            label.setStyle({
                backgroundColor: '#4A90E2',
                color: 'white',
                border: '2px solid white',
                borderRadius: '50%',
                width: '20px',
                height: '20px',
                lineHeight: '20px',
                textAlign: 'center',
                fontSize: '12px',
                fontWeight: 'bold'
            });
            
            const marker = new BMap.Marker(point);
            marker.setLabel(label);
            
            const infoWindow = new BMap.InfoWindow(
                `<div style="padding:10px;">
                    <strong>${index}. ${item.title}</strong><br>
                    <small>${item.location}</small>
                    ${item.time ? `<br><small>æ—¶é—´: ${item.time}</small>` : ''}
                </div>`,
                { width: 200, height: 'auto' }
            );
            
            marker.addEventListener('click', () => {
                map.openInfoWindow(infoWindow, point);
            });
            
            map.addOverlay(marker);
            return marker;
        }

        // æ¸…é™¤åœ°å›¾
        function clearMap() {
            const mapContainer = document.getElementById('map-container');
            if (mapContainer) {
                mapContainer.innerHTML = '';
                log("ğŸ—ºï¸ åœ°å›¾å·²æ¸…é™¤");
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥API Key
        window.addEventListener('load', () => {
            const apiKeys = localStorage.getItem('webplanner_api_keys');
            if (apiKeys) {
                const parsedKeys = JSON.parse(apiKeys);
                if (parsedKeys.baiduApiKey) {
                    log("âœ… æ£€æµ‹åˆ°å·²é…ç½®çš„API Key");
                } else {
                    log("âš ï¸ æœªæ£€æµ‹åˆ°ç™¾åº¦åœ°å›¾API Key");
                }
            } else {
                log("âš ï¸ æœªæ£€æµ‹åˆ°API Keyé…ç½®");
            }
        });
    </script>
</body>
</html>
